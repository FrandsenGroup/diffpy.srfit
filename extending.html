<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Extending SrFit &#8212; diffpy.srfit 3.0.0 documentation</title>
    <link rel="stylesheet" href="_static/pydoctheme.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/sidebar.js"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="License" href="license.html" />
    <link rel="prev" title="simplerecipe.py" href="examples/simplerecipe.html" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <link rel="shortcut icon" type="image/png" href="_static/favicon.png" />
    <meta name="viewport" content="width=device-width,initial-scale=0.8">
    
    

  </head><body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="responsive-menu"><a href="#sidebar-anchor" title="Navigation">&#9776;</a></li>
        <li><a href="index.html">diffpy.srfit 3.0.0 documentation</a> &#187;</li> 
      </ul>
    </div>
    
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="extending-srfit">
<span id="developers-guide-extending"></span><h1>Extending SrFit<a class="headerlink" href="#extending-srfit" title="Permalink to this headline">¶</a></h1>
<p>The <a class="reference internal" href="examples.html#developers-guide-examples"><span class="std std-ref">Examples</span></a> give an overview of how to
use SrFit and extend it with various custom-made objects. Many pieces of SrFit
that are not covered in the examples are discussed here.</p>
<div class="section" id="plugging-other-objects-into-srfit">
<h2>Plugging Other Objects into SrFit<a class="headerlink" href="#plugging-other-objects-into-srfit" title="Permalink to this headline">¶</a></h2>
<p>Much of the power of SrFit comes from being able to plug existing python codes
into the framework. For example, external forward calculators can be wrapped up
inside <code class="docutils literal notranslate"><span class="pre">ProfileGenerators</span></code> without modifying the calculator. This is
demonstrated in <a class="reference internal" href="examples.html#developers-guide-examples"><span class="std std-ref">Examples</span></a>. Structure adapters defined in
the diffpy.srfit.structure module are also built around this principle. These
adapters are hierarchical <code class="docutils literal notranslate"><span class="pre">ParameterSets</span></code> (found in
<code class="docutils literal notranslate"><span class="pre">diffpy.srfit.fitbase.parameterset</span></code>) that encapsulate the different pieces of
a structure.  For example, the <code class="docutils literal notranslate"><span class="pre">DiffpyStructureParSet</span></code> structure adapter in
<code class="docutils literal notranslate"><span class="pre">diffpy.srfit.structure.diffpyparset</span></code> contains <code class="docutils literal notranslate"><span class="pre">DiffpyLatticeParSet</span></code>, which
encapsulates the lattice data and one <code class="docutils literal notranslate"><span class="pre">DiffpyAtomParSet</span></code> per atom.  These
each contain parameters for what they encapsulate, such as lattice parameters
or atom positions.</p>
<p>Fundamentally, it is the adjustable parameters of a structure container,
forward calculator or other object that needs to be adapted so that SrFit can
manipulate the underlying data object. These adapted parameters can then be
organized into <code class="docutils literal notranslate"><span class="pre">ParameterSets</span></code>, as in the case of a structure adapter. The
<code class="docutils literal notranslate"><span class="pre">ParameterAdapter</span></code> class found in <code class="docutils literal notranslate"><span class="pre">diffpy.srfit.fitbase.parameter</span></code> is
designed for this purpose. <code class="docutils literal notranslate"><span class="pre">ParameterAdapter</span></code> is a <code class="docutils literal notranslate"><span class="pre">Parameter</span></code> that defers
to another object when setting or retrieving its value.</p>
<dl class="class">
<dt id="diffpy.srfit.fitbase.parameter.ParameterAdapter">
<em class="property">class </em><code class="descclassname">diffpy.srfit.fitbase.parameter.</code><code class="descname">ParameterAdapter</code><span class="sig-paren">(</span><em>name</em>, <em>obj</em>, <em>getter=None</em>, <em>setter=None</em>, <em>attr=None</em><span class="sig-paren">)</span><a class="headerlink" href="#diffpy.srfit.fitbase.parameter.ParameterAdapter" title="Permalink to this definition">¶</a></dt>
<dd><p>An adapter for parameter-like objects.</p>
<p>This class wraps an object as a Parameter. The getValue and setValue
methods defer to the data of the wrapped object.</p>
<p>The <cite>name</cite> argument is used to give attribute access to the
ParameterAdapter instance when it is added to a ParameterSet or similar
object. The <cite>obj</cite> argument is the parameter-like object to be adapted. It
must provide some form of access to its data. If it provides a getter and
setter, these can be specified with the <cite>getter</cite> and <cite>setter</cite> arguments.
If the getter and setter require an attribute name, this is specified with
the <cite>attr</cite> argument. If the data can be retrieved as an attribute, then the
name of this attribute can be passed in the <cite>attr</cite> argument.</p>
</dd></dl>

<p>Here is a simple example of using <code class="docutils literal notranslate"><span class="pre">ParameterAdapter</span></code> to adapt a hypothetical
atom object called <code class="docutils literal notranslate"><span class="pre">SimpleAtom</span></code> that has attributes <code class="docutils literal notranslate"><span class="pre">x</span></code>, <code class="docutils literal notranslate"><span class="pre">y</span></code> and <code class="docutils literal notranslate"><span class="pre">z</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SimpleAtom</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Simple class holding x, y and z coordinates of an atom.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">z</span>
        <span class="k">return</span>

<span class="c1"># End class SimpleAtom</span>

<span class="k">class</span> <span class="nc">SimpleAtomParSet</span><span class="p">(</span><span class="n">ParameterSet</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class adapting the x, y and z attributes of SimpleAtom as Parameters.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">ParameterSet</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="c1"># Store the atom, we might need it later</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atom</span> <span class="o">=</span> <span class="n">atom</span>

        <span class="c1"># Create a ParameterAdapter for the x, y and z attributes of atom</span>
        <span class="n">xpar</span> <span class="o">=</span> <span class="n">ParameterAdapter</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">atom</span><span class="p">,</span> <span class="n">attr</span> <span class="o">=</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
        <span class="n">ypar</span> <span class="o">=</span> <span class="n">ParameterAdapter</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">atom</span><span class="p">,</span> <span class="n">attr</span> <span class="o">=</span> <span class="s2">&quot;y&quot;</span><span class="p">)</span>
        <span class="n">zpar</span> <span class="o">=</span> <span class="n">ParameterAdapter</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="n">atom</span><span class="p">,</span> <span class="n">attr</span> <span class="o">=</span> <span class="s2">&quot;z&quot;</span><span class="p">)</span>

        <span class="c1"># Add these to the parameter set</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addParameter</span><span class="p">(</span><span class="n">xpar</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addParameter</span><span class="p">(</span><span class="n">ypar</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addParameter</span><span class="p">(</span><span class="n">zpar</span><span class="p">)</span>

        <span class="k">return</span>

<span class="c1"># End class SimpleAtomParSet</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">x</span></code>, <code class="docutils literal notranslate"><span class="pre">y</span></code> and <code class="docutils literal notranslate"><span class="pre">z</span></code> attributes (specified by the <code class="docutils literal notranslate"><span class="pre">attr</span></code> keyword
argument of <code class="docutils literal notranslate"><span class="pre">ParameterAdapter</span></code>) of a <code class="docutils literal notranslate"><span class="pre">SimpleAtom</span></code> are wrapped as
<code class="docutils literal notranslate"><span class="pre">ParameterAdapter</span></code> objects named <cite>x</cite>, <cite>y</cite>, and <cite>z</cite>.  They are then added to
the <code class="docutils literal notranslate"><span class="pre">SimpleAtomParSet</span></code> using the <code class="docutils literal notranslate"><span class="pre">addParameter</span></code> method, which makes them
accessible as attributes.</p>
<p>If SimpleAtom did not have an attribute named <code class="docutils literal notranslate"><span class="pre">x</span></code>, but rather accessor
methods named <code class="docutils literal notranslate"><span class="pre">getX</span></code> and <code class="docutils literal notranslate"><span class="pre">setX</span></code>, then the <code class="docutils literal notranslate"><span class="pre">ParameterAdapter</span></code> would be
used as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">xpar</span> <span class="o">=</span> <span class="n">ParameterAdapter</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">atom</span><span class="p">,</span> <span class="n">getter</span> <span class="o">=</span> <span class="n">SimpleAtom</span><span class="o">.</span><span class="n">getX</span><span class="p">,</span>
    <span class="n">setter</span> <span class="o">=</span> <span class="n">SimpleAtom</span><span class="o">.</span><span class="n">setX</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that the <em>unbound</em> methods are used. The names <code class="docutils literal notranslate"><span class="pre">getter</span></code> and <code class="docutils literal notranslate"><span class="pre">setter</span></code>
describe how the accessor attributes are used to access the value of the
parameter. When <code class="docutils literal notranslate"><span class="pre">xpar.getValue()</span></code> is called, it redirects to
<code class="docutils literal notranslate"><span class="pre">SimpleAtom.getX(atom)</span></code>.</p>
<p>If instead <code class="docutils literal notranslate"><span class="pre">SimpleAtom</span></code> had methods called <code class="docutils literal notranslate"><span class="pre">get</span></code> and <code class="docutils literal notranslate"><span class="pre">set</span></code> that take as
the second argument the name of the attribute to retrieve or modify, then this
can be adapted as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">xpar</span> <span class="o">=</span> <span class="n">ParameterAdapter</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">atom</span><span class="p">,</span> <span class="n">getter</span> <span class="o">=</span> <span class="n">SimpleAtom</span><span class="o">.</span><span class="n">get</span><span class="p">,</span>
        <span class="n">setter</span> <span class="o">=</span> <span class="n">SimpleAtom</span><span class="o">.</span><span class="n">set</span><span class="p">,</span> <span class="n">attr</span> <span class="o">=</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Thus, when <code class="docutils literal notranslate"><span class="pre">xpar.getValue()</span></code> is called, it in turn calls
<code class="docutils literal notranslate"><span class="pre">SimpleAtom.get(atom,</span> <span class="pre">&quot;x&quot;)</span></code>. <code class="docutils literal notranslate"><span class="pre">xpar.setValue(value)</span></code> calls
<code class="docutils literal notranslate"><span class="pre">SimpleAtom.set(atom,</span> <span class="pre">&quot;x&quot;,</span> <span class="pre">value)</span></code>.</p>
<p>If the attributes of an object cannot be accessed in one of these three ways,
then you must write external accessor methods that can be set as the getter and
setter of the <code class="docutils literal notranslate"><span class="pre">ParameterAdapter</span></code>. For example, if the <code class="docutils literal notranslate"><span class="pre">x</span></code>, <code class="docutils literal notranslate"><span class="pre">y</span></code> and <code class="docutils literal notranslate"><span class="pre">z</span></code>
values were held in a list called <code class="docutils literal notranslate"><span class="pre">xyz</span></code>, then you would have to write the
functions <code class="docutils literal notranslate"><span class="pre">getX</span></code> and <code class="docutils literal notranslate"><span class="pre">setX</span></code> that would manipulate this list, and use these
functions as in the second example.</p>
</div>
<div class="section" id="extending-profile-parsers">
<h2>Extending Profile Parsers<a class="headerlink" href="#extending-profile-parsers" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">ProfileParser</span></code> class is located in the <code class="docutils literal notranslate"><span class="pre">diffpy.srfit.fitbase.parser</span></code>
module.  The purpose of this class is to read data and metadata from a file or
string and pass those data and metadata to a <code class="docutils literal notranslate"><span class="pre">Profile</span></code> instance. The
<code class="docutils literal notranslate"><span class="pre">Profile</span></code> in turn will pass this information to a <code class="docutils literal notranslate"><span class="pre">ProfileGenerator</span></code>.</p>
<p>The simplest way to extend the <code class="docutils literal notranslate"><span class="pre">ProfileParser</span></code> is to derive a new class from
<code class="docutils literal notranslate"><span class="pre">ProfileParser</span></code> and overload the <code class="docutils literal notranslate"><span class="pre">parseString</span></code> method. By default, the
<code class="docutils literal notranslate"><span class="pre">parseFile</span></code> method can read an ASCII file and passes the loaded string to the
<code class="docutils literal notranslate"><span class="pre">parseString</span></code> method. For non-ASCII data one should overload both of these
methods. An example of a customized <code class="docutils literal notranslate"><span class="pre">ProfileParser</span></code> is the <code class="docutils literal notranslate"><span class="pre">PDFParser</span></code>
class in the <code class="docutils literal notranslate"><span class="pre">diffpy.srfit.pdf.pdfparser</span></code> module.</p>
<p>Here is a simple example demonstrating how to extract (x,y) data from a
two-column string.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">parseString</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datastring</span><span class="p">):</span>

    <span class="n">xvals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">yvals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dxvals</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">dyvals</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">datastring</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>

        <span class="n">sline</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">sline</span><span class="p">)</span>
        <span class="n">xvals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">yvals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_banks</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">xvals</span><span class="p">,</span> <span class="n">yvals</span><span class="p">,</span> <span class="n">dxvals</span><span class="p">,</span> <span class="n">dyvals</span><span class="p">])</span>
    <span class="k">return</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">self._banks.append</span></code> line puts the data arrays into the <code class="docutils literal notranslate"><span class="pre">_banks</span></code> list.
This list is for collecting multiple data sets that may be present within a
single file.  The <code class="docutils literal notranslate"><span class="pre">dxvals</span></code> and <code class="docutils literal notranslate"><span class="pre">dyvals</span></code> are the uncertainty values on the
<code class="docutils literal notranslate"><span class="pre">xvals</span></code> and <code class="docutils literal notranslate"><span class="pre">yvals</span></code>.  In this simple example they are not present, and so
are set to None.</p>
<p>In general, the data string may contain metadata. The <code class="docutils literal notranslate"><span class="pre">ProfileParser</span></code> has a
dictionary attribute named <code class="docutils literal notranslate"><span class="pre">_meta</span></code>. The parser can put any information into
this dictionary. It is up to a <code class="docutils literal notranslate"><span class="pre">ProfileGenerator</span></code> that may use the parsed
data to define and retrieve usable metadata.</p>
<p>If the data are not in a form that can be stored in a <code class="docutils literal notranslate"><span class="pre">Profile</span></code> then it is
the responsibility of the parser to convert this data to a usable form.</p>
</div>
<div class="section" id="extending-profiles">
<h2>Extending Profiles<a class="headerlink" href="#extending-profiles" title="Permalink to this headline">¶</a></h2>
<p>Even with the ability to customize <code class="docutils literal notranslate"><span class="pre">ProfileParsers,</span></code> it may be necessary to
create custom <code class="docutils literal notranslate"><span class="pre">Profile</span></code> objects for different types of data. This is useful
when adapting an external data container to the SrFit interface. For example,
the external container may need to be retained so it can be used within an
external program before or after interfacing with SrFit. An example of a
customized Profile is the <code class="docutils literal notranslate"><span class="pre">SASProfile</span></code> class in the
<code class="docutils literal notranslate"><span class="pre">diffpy.srfit.sas.sasprofile</span></code> module:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SASProfile</span><span class="p">(</span><span class="n">Profile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Observed and calculated profile container for SAS data.</span>

<span class="sd">    This wraps a sas DataInfo object as a Profile object. Use this when you</span>
<span class="sd">    want to use and manipulate a DataProfile before using it with SrFit.</span>
<span class="sd">    Otherwise, use the SASParser class and load the data into a base Profile</span>
<span class="sd">    object.</span>

<span class="sd">    Attributes</span>

<span class="sd">    _xobs   --  A numpy array of the observed independent variable (default</span>
<span class="sd">                None)</span>
<span class="sd">    xobs    --  Read-only property of _xobs.</span>
<span class="sd">    _yobs   --  A numpy array of the observed signal (default None)</span>
<span class="sd">    yobs    --  Read-only property of _yobs.</span>
<span class="sd">    _dyobs  --  A numpy array of the uncertainty of the observed signal (default</span>
<span class="sd">                None, optional).</span>
<span class="sd">    dyobs   --  Read-only property of _dyobs.</span>
<span class="sd">    x       --  A numpy array of the calculated independent variable (default</span>
<span class="sd">                None, property for xpar accessors).</span>
<span class="sd">    y       --  The profile over the calculation range (default None, property</span>
<span class="sd">                for ypar accessors).</span>
<span class="sd">    dy      --  The uncertainty in the profile over the calculation range</span>
<span class="sd">                (default None, property for dypar accessors).</span>
<span class="sd">    ycalc   --  A numpy array of the calculated signal (default None).</span>
<span class="sd">    xpar    --  A ProfileParameter that stores x (named &quot;x&quot;).</span>
<span class="sd">    ypar    --  A ProfileParameter that stores y (named &quot;y&quot;).</span>
<span class="sd">    dypar   --  A ProfileParameter that stores dy (named &quot;dy&quot;).</span>
<span class="sd">    meta    --  A dictionary of metadata. This is only set if provided by a</span>
<span class="sd">                parser.</span>

<span class="sd">    _datainfo   --  The DataInfo object this wraps.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datainfo</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the attributes.</span>

<span class="sd">        datainfo   --  The DataInfo object this wraps.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_datainfo</span> <span class="o">=</span> <span class="n">datainfo</span>
        <span class="n">Profile</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_xobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datainfo</span><span class="o">.</span><span class="n">x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_yobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datainfo</span><span class="o">.</span><span class="n">y</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datainfo</span><span class="o">.</span><span class="n">dy</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="mi">0</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_datainfo</span><span class="o">.</span><span class="n">dy</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dyobs</span> <span class="o">=</span> <span class="n">ones_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xobs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dyobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datainfo</span><span class="o">.</span><span class="n">dy</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">setObservedProfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xobs</span><span class="p">,</span> <span class="n">yobs</span><span class="p">,</span> <span class="n">dyobs</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the observed profile.</span>

<span class="sd">        This is overloaded to change the value within the datainfo object.</span>

<span class="sd">        Arguments</span>
<span class="sd">        xobs    --  Numpy array of the independent variable</span>
<span class="sd">        yobs    --  Numpy array of the observed signal.</span>
<span class="sd">        dyobs   --  Numpy array of the uncertainty in the observed signal. If</span>
<span class="sd">                    dyobs is None (default), it will be set to 1 at each</span>
<span class="sd">                    observed xobs.</span>

<span class="sd">        Raises ValueError if len(yobs) != len(xobs)</span>
<span class="sd">        Raises ValueError if dyobs != None and len(dyobs) != len(xobs)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Profile</span><span class="o">.</span><span class="n">setObservedProfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xobs</span><span class="p">,</span> <span class="n">yobs</span><span class="p">,</span> <span class="n">dyobs</span><span class="p">)</span>
        <span class="c1"># Copy the arrays to the _datainfo attribute.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_datainfo</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xobs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_datainfo</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_yobs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_datainfo</span><span class="o">.</span><span class="n">dy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dyobs</span>
        <span class="k">return</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">__init__</span></code> method sets the <code class="docutils literal notranslate"><span class="pre">xobs</span></code>, <code class="docutils literal notranslate"><span class="pre">yobs</span></code> and <code class="docutils literal notranslate"><span class="pre">dyobs</span></code> attributes of
the <code class="docutils literal notranslate"><span class="pre">SASProfile</span></code> to the associated arrays within the <code class="docutils literal notranslate"><span class="pre">_datainfo</span></code> attribute.
The <code class="docutils literal notranslate"><span class="pre">setObservedProfile</span></code> method is overloaded to modify the <code class="docutils literal notranslate"><span class="pre">_datainfo</span></code>
arrays when their corresponding attributes are modified. This keeps the arrays
in sync.</p>
</div>
<div class="section" id="custom-restraints">
<h2>Custom Restraints<a class="headerlink" href="#custom-restraints" title="Permalink to this headline">¶</a></h2>
<p>Restraints in SrFit are one way to include known information about a system
into a fit recipe. When customizing SrFit for a specific purpose, one may want
to create restraints. One example of this is in the <code class="docutils literal notranslate"><span class="pre">SrRealParSet</span></code> base class
in <code class="docutils literal notranslate"><span class="pre">diffpy.srfit.structure.srrealparset</span></code>. SrReal provides many real-space
structure utilities for compatible structures, such as a PDF calculator and a
bond-valence sum (BVS) calculator. The PDF calculator works very well as a
<code class="docutils literal notranslate"><span class="pre">ProfileGenerator</span></code> (see the <a class="reference internal" href="examples.html#developers-guide-examples"><span class="std std-ref">Examples</span></a>), but the BVS
calculator is better suited as a restraint. This makes it very easy to keep the
BVS constrained during a PDF fit or some other refinement.</p>
<p>Creating a custom restraint is a two-step process. First, a class must be
derived from <code class="docutils literal notranslate"><span class="pre">diffpy.srfit.fitbase.restraint.Restraint</span></code> that can calculate
the restraint cost.  This requires the <code class="docutils literal notranslate"><span class="pre">penalty</span></code> method to be overloaded.
This method has the following signature</p>
<dl class="method">
<dt id="diffpy.srfit.fitbase.restraint.Restraint.penalty">
<code class="descclassname">Restraint.</code><code class="descname">penalty</code><span class="sig-paren">(</span><em>w=1.0</em><span class="sig-paren">)</span><a class="headerlink" href="#diffpy.srfit.fitbase.restraint.Restraint.penalty" title="Permalink to this definition">¶</a></dt>
<dd><p>Calculate the penalty of the restraint.</p>
<dl class="docutils">
<dt>w   –  The point-average chi^2 which is optionally used to scale the</dt>
<dd>penalty (default 1.0).</dd>
</dl>
<p>Returns the penalty as a float</p>
</dd></dl>

<p>The <cite>w</cite> factor is optionally used to scale the restraint cost. Its purpose is
to keep the restraint cost comparable to the residual of a single data point.</p>
<p><code class="docutils literal notranslate"><span class="pre">BVSRestraint</span></code> from <code class="docutils literal notranslate"><span class="pre">diffpy.srfit.structure.bvsrestraint</span></code> is a custom
<code class="docutils literal notranslate"><span class="pre">Restraint</span></code> whose penalty is the root-mean-square deviation from the expected
and calculated BVS of a structure.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">BVSRestraint</span><span class="p">(</span><span class="n">Restraint</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Wrapping of BVSCalculator.bvmsdiff as a Restraint.</span>

<span class="sd">    The restraint penalty is the root-mean-square deviation of the theoretical</span>
<span class="sd">    and calculated bond-valence sum of a structure.</span>

<span class="sd">    Attributes:</span>
<span class="sd">    _calc   --  The SrReal BVSCalculator instance.</span>
<span class="sd">    _parset --  The SrRealParSet that created this BVSRestraint.</span>
<span class="sd">    sig     --  The uncertainty on the BVS (default 1).</span>
<span class="sd">    scaled  --  A flag indicating if the restraint is scaled (multiplied)</span>
<span class="sd">                by the unrestrained point-average chi^2 (chi^2/numpoints)</span>
<span class="sd">                (default False).</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parset</span><span class="p">,</span> <span class="n">sig</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">scaled</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the Restraint.</span>

<span class="sd">        parset  --  SrRealParSet that creates this BVSRestraint.</span>
<span class="sd">        sig     --  The uncertainty on the BVS (default 1).</span>
<span class="sd">        scaled  --  A flag indicating if the restraint is scaled</span>
<span class="sd">                    (multiplied) by the unrestrained point-average chi^2</span>
<span class="sd">                    (chi^2/numpoints) (bool, default False).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">diffpy.srreal.bvscalculator</span> <span class="k">import</span> <span class="n">BVSCalculator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calc</span> <span class="o">=</span> <span class="n">BVSCalculator</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parset</span> <span class="o">=</span> <span class="n">parset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaled</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">scaled</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">penalty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculate the penalty of the restraint.</span>

<span class="sd">        w   --  The point-average chi^2 which is optionally used to scale the</span>
<span class="sd">                penalty (float, default 1.0).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the bvms from the BVSCalculator</span>
        <span class="n">stru</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parset</span><span class="o">.</span><span class="n">_getSrRealStructure</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calc</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">stru</span><span class="p">)</span>
        <span class="n">penalty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc</span><span class="o">.</span><span class="n">bvmsdiff</span>

        <span class="c1"># Scale by the prefactor</span>
        <span class="n">penalty</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sig</span><span class="o">**</span><span class="mi">2</span>

        <span class="c1"># Optionally scale by w</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaled</span><span class="p">:</span> <span class="n">penalty</span> <span class="o">*=</span> <span class="n">w</span>

        <span class="k">return</span> <span class="n">penalty</span>

    <span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This evaluates the calculator.</span>

<span class="sd">        Raises SrFitError if validation fails.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">nan</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">penalty</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">p</span> <span class="ow">is</span> <span class="n">nan</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SrFitError</span><span class="p">(</span><span class="s2">&quot;Cannot evaluate penalty&quot;</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">v</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">emsg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Bond valence sums are all zero.  Check atom symbols in &quot;</span>
                    <span class="s2">&quot;the structure or define custom bond-valence parameters.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">SrFitError</span><span class="p">(</span><span class="n">emsg</span><span class="p">)</span>
        <span class="k">return</span>
</pre></div>
</div>
<p>Note that the penalty scaling is optional (selected by the <cite>scaled</cite> flag) and
uncertainty on the result (<cite>sig</cite>) may be applied. These two options are
recommended with any custom <code class="docutils literal notranslate"><span class="pre">Restraint</span></code>.</p>
<p>The second part of a custom restraint is to allow it to be created from a
restrainable object. A <code class="docutils literal notranslate"><span class="pre">BVSRestraint</span></code> is used to restrain a <code class="docutils literal notranslate"><span class="pre">SrRealParSet</span></code>,
which is a <code class="docutils literal notranslate"><span class="pre">ParameterSet</span></code> wrapper base class for SrReal-compatible
structures.  The restraint is applied with the <code class="docutils literal notranslate"><span class="pre">restrainBVS</span></code> method.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">restrainBVS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sig</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">scaled</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Restrain the bond-valence sum to zero.</span>

<span class="sd">        This adds a penalty to the cost function equal to</span>
<span class="sd">        bvmsdiff / sig**2</span>
<span class="sd">        where bvmsdiff is the mean-squared difference between the calculated</span>
<span class="sd">        and expected bond valence sums for the structure. If scaled is True,</span>
<span class="sd">        this is also scaled by the current point-averaged chi^2 value so the</span>
<span class="sd">        restraint is roughly equally weighted in the fit.</span>

<span class="sd">        sig     --  The uncertainty on the BVS (default 1).</span>
<span class="sd">        scaled  --  A flag indicating if the restraint is scaled</span>
<span class="sd">                    (multiplied) by the unrestrained point-average chi^2</span>
<span class="sd">                    (chi^2/numpoints) (default False).</span>

<span class="sd">        Returns the BVSRestraint object for use with the &#39;unrestrain&#39; method.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Create the Restraint object</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">BVSRestraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">scaled</span><span class="p">)</span>
        <span class="c1"># Add it to the _restraints set</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_restraints</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="c1"># Our configuration changed. Notify observers.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_updateConfiguration</span><span class="p">()</span>
        <span class="c1"># Return the Restraint object</span>
        <span class="k">return</span> <span class="n">res</span>
</pre></div>
</div>
<p>The purpose of the method is to create the custom <code class="docutils literal notranslate"><span class="pre">Restraint</span></code> object,
configure it and store it. Note that the optional <cite>sig</cite> and <cite>scaled</cite> flag are
passed as part of this method. Both <code class="docutils literal notranslate"><span class="pre">_restraints</span></code> and
<code class="docutils literal notranslate"><span class="pre">_updateConfiguration</span></code> come from <code class="docutils literal notranslate"><span class="pre">ParameterSet</span></code>, from which
<code class="docutils literal notranslate"><span class="pre">SrRealParSet</span></code> is derived. The <code class="docutils literal notranslate"><span class="pre">_restraints</span></code> attribute is a set of
<code class="docutils literal notranslate"><span class="pre">Restraints</span></code> on the object. The <code class="docutils literal notranslate"><span class="pre">_updateConfiguration</span></code> method makes any
object containing the <code class="docutils literal notranslate"><span class="pre">SrRealParSet</span></code> aware of the configuration change.  This
gets propagated to the top-level <code class="docutils literal notranslate"><span class="pre">FitRecipe</span></code>, if there is one.  The restraint
object is returned by the method so that it may be later removed.</p>
<p>For more examples of custom restraints can be found in the
<code class="docutils literal notranslate"><span class="pre">diffpy.srfit.structure.objcrystparset</span></code> module.</p>
</div>
<div class="section" id="custom-fithooks">
<h2>Custom FitHooks<a class="headerlink" href="#custom-fithooks" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">FitHook</span></code> class is used by a <code class="docutils literal notranslate"><span class="pre">FitRecipe</span></code> to report fit progress to a
user.  <code class="docutils literal notranslate"><span class="pre">FitHook</span></code> can be found in the <code class="docutils literal notranslate"><span class="pre">diffpy.srfit.fitbase.fithook</span></code> module.
<code class="docutils literal notranslate"><span class="pre">FitHook</span></code> can be customized to provide customized fit output, such as a live
plot of the output. The <code class="docutils literal notranslate"><span class="pre">FitHook</span></code> class has three methods that one can
overload.</p>
<ul>
<li><dl class="method">
<dt id="diffpy.srfit.fitbase.fithook.FitHook.reset">
<code class="descclassname">FitHook.</code><code class="descname">reset</code><span class="sig-paren">(</span><em>recipe</em><span class="sig-paren">)</span><a class="headerlink" href="#diffpy.srfit.fitbase.fithook.FitHook.reset" title="Permalink to this definition">¶</a></dt>
<dd><p>Reset the hook data.</p>
<p>This is called whenever FitRecipe._prepare is called, which is whenever
a configurational change to the fit hierarchy takes place, such as
adding a new ParameterSet, constraint or restraint.</p>
</dd></dl>

</li>
<li><dl class="method">
<dt id="diffpy.srfit.fitbase.fithook.FitHook.precall">
<code class="descclassname">FitHook.</code><code class="descname">precall</code><span class="sig-paren">(</span><em>recipe</em><span class="sig-paren">)</span><a class="headerlink" href="#diffpy.srfit.fitbase.fithook.FitHook.precall" title="Permalink to this definition">¶</a></dt>
<dd><p>This is called within FitRecipe.residual, before the calculation.</p>
<p>recipe  –  The FitRecipe instance</p>
</dd></dl>

</li>
<li><dl class="method">
<dt id="diffpy.srfit.fitbase.fithook.FitHook.postcall">
<code class="descclassname">FitHook.</code><code class="descname">postcall</code><span class="sig-paren">(</span><em>recipe</em>, <em>chiv</em><span class="sig-paren">)</span><a class="headerlink" href="#diffpy.srfit.fitbase.fithook.FitHook.postcall" title="Permalink to this definition">¶</a></dt>
<dd><p>This is called within FitRecipe.residual, after the calculation.</p>
<p>recipe  –  The FitRecipe instance
chiv    –  The residual vector</p>
</dd></dl>

</li>
</ul>
<p>To use a custom <code class="docutils literal notranslate"><span class="pre">FitHook</span></code>, assign an instance to a <code class="docutils literal notranslate"><span class="pre">FitRecipe</span></code> using the
<code class="docutils literal notranslate"><span class="pre">pushFitHook</span></code> method. All <code class="docutils literal notranslate"><span class="pre">FitHook</span></code> instances held by a <code class="docutils literal notranslate"><span class="pre">FitRecipe</span></code> will
be used in sequence during a call to <code class="docutils literal notranslate"><span class="pre">FitRecipe.residual</span></code>.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
    <a id="sidebar-anchor"></a>
    

  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Extending SrFit</a><ul>
<li><a class="reference internal" href="#plugging-other-objects-into-srfit">Plugging Other Objects into SrFit</a></li>
<li><a class="reference internal" href="#extending-profile-parsers">Extending Profile Parsers</a></li>
<li><a class="reference internal" href="#extending-profiles">Extending Profiles</a></li>
<li><a class="reference internal" href="#custom-restraints">Custom Restraints</a></li>
<li><a class="reference internal" href="#custom-fithooks">Custom FitHooks</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="examples/simplerecipe.html"
                        title="previous chapter">simplerecipe.py</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="license.html"
                        title="next chapter">License</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/extending.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="license.html" title="License"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="examples/simplerecipe.html" title="simplerecipe.py"
             accesskey="P">previous</a> |</li>
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2019, Brookhaven National Laboratory.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.5.
    </div>
  </body>
</html>